<!--
common.xml

Ant build file for logic common to every component.
All component build files inherit from this build file.
Download Apache Ant from http://ant.apache.org/.
Type "ant -p" for a list of targets.
-->

<project>
  <import file="${root.dir}/global.xml"/>
  <property file="${root.dir}/components/common.properties"/>

  <!-- Main build targets -->

  <target name="clean" description="remove all build files except artifacts">
    <delete dir="${build.dir}"/>
  </target>

  <!-- Internal build targets -->

  <target name="init-timestamp">
    <tstamp>
      <format property="DATE" pattern="d MMMMM yyyy"/>
      <format property="YEAR" pattern="yyyy"/>
    </tstamp>
  </target>

  <target name="init-svn">
    <!-- determine SVN and version statistics -->
    <if>
      <isset property="svn.log"/>
      <else>
        <loadfile property="svn.entries" srcFile="${basedir}/.svn/entries"/>

        <propertyregex property="svn.revision"
          input="${svn.entries}" regexp="([^\n]*\n){4}" select="\1"/>
        <echo>SVN revision: ${svn.revision}</echo>

        <propertyregex property="svn.url"
          input="${svn.entries}" regexp="([^\n]*\n){5}" select="\1"/>
        <echo>SVN url: ${svn.url}</echo>

        <propertyregex property="svn.root"
          input="${svn.entries}" regexp="([^\n]*\n){6}" select="\1"/>
        <echo>SVN root: ${svn.root}</echo>

        <propertyregex property="svn.date"
          input="${svn.entries}" regexp="([^\n]*\n){10}" select="\1"/>
        <echo>SVN last changed date: ${svn.date}</echo>

        <propertyregex property="svn.changed"
          input="${svn.entries}" regexp="([^\n]*\n){11}" select="\1"/>
        <echo>SVN last changed revision: ${svn.changed}</echo>

        <propertyregex property="release.version" defaultValue="trunk"
          input="${svn.url}" regexp=".*/branches/([^/]*).*"
          replace="dev \1"/>
        <propertyregex property="release.version" override="true"
          defaultValue="${release.version}"
          input="${svn.url}" regexp=".*/tags/loci-tools-([^/]*).*"
          replace="stable \1"/>
        <echo>Release version: ${release.version}</echo>
      </else>
    </if>
  </target>

</project>
